name: Build Site from Google Sheet

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Check out repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install Python dependencies
      run: pip install gspread google-auth-oauthlib

    - name: Create Google Sheets fetch script
      run: |
        cat << 'EOF' > fetch_sheets.py
        import csv
        import gspread
        import os
        import sys
        import json

        def fetch_sheet_data(credentials_json_str, sheet_id, sheet_name, output_csv_path):
            try:
                credentials_json = json.loads(credentials_json_str)
                creds = gspread.service_account_from_dict(credentials_json)
                client = gspread.authorize(creds)

                spreadsheet = client.open_by_key(sheet_id)
                worksheet = spreadsheet.worksheet(sheet_name)
                
                data = worksheet.get_all_values()
                
                with open(output_csv_path, 'w', newline='', encoding='utf-8') as f:
                    writer = csv.writer(f)
                    writer.writerows(data)
                    
                print(f"Successfully fetched '{sheet_name}' and saved to '{output_csv_path}'")

            except Exception as e:
                print(f"Error fetching sheet data for '{sheet_name}': {e}", file=sys.stderr)
                sys.exit(1)

        if __name__ == "__main__":
            if len(sys.argv) != 4:
                print("Usage: python fetch_sheets.py <sheet_name> <output_csv_path> <sheet_id>", file=sys.stderr)
                sys.exit(1)

            credentials_json_str = os.getenv('GCP_SA_KEY')
            if not credentials_json_str:
                print("Error: GCP_SA_KEY environment variable not set.", file=sys.stderr)
                sys.exit(1)
                
            sheet_name = sys.argv[1]
            output_csv_path = sys.argv[2]
            sheet_id = sys.argv[3]

            fetch_sheet_data(credentials_json_str, sheet_id, sheet_name, output_csv_path)
        EOF

    - name: Fetch data from Google Sheets
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        SHEET_ID: ${{ secrets.SHEET_ID }}
      run: |
        if [ -z "$GCP_SA_KEY" ] || [ -z "$SHEET_ID" ]; then
          echo "GCP_SA_KEY or SHEET_ID secret not set. Skipping Google Sheets fetch."
          exit 0
        fi
        python fetch_sheets.py "General" "goated prompts - General.csv" "$SHEET_ID"
        python fetch_sheets.py "Stocks" "goated prompts - Stocks.csv" "$SHEET_ID"
        python fetch_sheets.py "Studying" "goated prompts - Studying.csv" "$SHEET_ID"

    - name: Create HTML conversion script
      run: |
        cat << 'EOF' > csv_to_html.py
        import csv
        import sys
        import html

        def csv_to_html(csv_file_path, html_file_path, title):
            with open(csv_file_path, 'r', encoding='utf-8') as csv_file:
                reader = csv.reader(csv_file)
                try:
                    header = next(reader)
                except StopIteration:
                    header = [] # Handle empty file
                rows = list(reader)

            # Find the index of the 'Prompt' column
            prompt_column_index = -1
            if 'Prompt' in header:
                prompt_column_index = header.index('Prompt')

            with open(html_file_path, 'w', encoding='utf-8') as html_file:
                html_file.write('<!DOCTYPE html>')
                html_file.write('<html lang="en">')
                html_file.write('<head>')
                html_file.write('    <meta charset="UTF-8">')
                html_file.write('    <meta name="viewport" content="width=device-width, initial-scale=1.0">')
                html_file.write(f'<title>{title}</title>')
                html_file.write('    <link rel="stylesheet" href="../style.css">')
                html_file.write('</head>')
                html_file.write('<body>')
                html_file.write('    <header>')
                html_file.write(f'<h1><a href="../index.html">Goated Prompts</a> / {title}</h1>')
                html_file.write('        <button id="theme-switcher">Theme</button>')
                html_file.write('    </header>')
                html_file.write('    <main>')
                html_file.write('        <table>')
                html_file.write('            <thead>')
                html_file.write('                <tr>')
                for col in header:
                    html_file.write(f'                    <th>{html.escape(col)}</th>')
                html_file.write('                </tr>')
                html_file.write('            </thead>')
                html_file.write('            <tbody>')
                for row in rows:
                    if not any(field.strip() for field in row):
                        continue
                    html_file.write('                <tr>')
                    for i, col in enumerate(row):
                        if i == prompt_column_index:
                            cell_content = f'<pre><code>{html.escape(col)}</code></pre>'
                        else:
                            cell_content = html.escape(col).replace('\n', '<br>')
                        html_file.write(f'                    <td data-label="{html.escape(header[i])}">{cell_content}</td>')
                    html_file.write('                </tr>')
                html_file.write('            </tbody>')
                html_file.write('        </table>')
                html_file.write('    </main>')
                html_file.write('    <footer>')
                html_file.write('        Made by <a href="https://gabrielongzm.com" target="_blank">Gabriel Ong</a>.')
                html_file.write('        Source: <a href="https://github.com/gongahkia/goated-prompts" target="_blank">gongahkia/goated-prompts</a>')
                html_file.write('    </footer>')
                html_file.write('    <script src="../script.js"></script>')
                html_file.write('</body>')
                html_file.write('</html>')

        if __name__ == "__main__":
            if len(sys.argv) != 4:
                print("Usage: python csv_to_html.py <csv_file> <html_file> <title>")
                sys.exit(1)
            csv_to_html(sys.argv[1], sys.argv[2], sys.argv[3])
        EOF

    - name: Run HTML conversion script
      run: |
        python csv_to_html.py "goated prompts - General.csv" "docs/General.html" "General"
        python csv_to_html.py "goated prompts - Stocks.csv" "docs/Stocks.html" "Stocks"
        python csv_to_html.py "goated prompts - Studying.csv" "docs/Studying.html" "Studying"

    - name: Commit and push if changed
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add .
        if ! git diff --staged --quiet; then
          git commit -m "Automated build: Update CSV from Google Sheets and rebuild HTML"
          git push
        else
          echo "No changes to commit"
        fi
