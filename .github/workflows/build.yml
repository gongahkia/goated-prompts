name: Build Site from Google Sheet

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering
  schedule:
    - cron: '0 0 * * 1' # Runs every Monday at 00:00 UTC (8 AM SGT)

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Check out repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install Python dependencies
      run: pip install gspread google-auth-oauthlib

    - name: Fetch data from Google Sheets
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        SHEET_ID: ${{ secrets.SHEET_ID }}
      run: |
        if [ -z "$GCP_SA_KEY" ] || [ -z "$SHEET_ID" ]; then
          echo "GCP_SA_KEY or SHEET_ID secret not set. Skipping Google Sheets fetch."
          exit 0
        fi
        python fetch_sheets.py "General" "goated prompts - General.csv" "$SHEET_ID"
        python fetch_sheets.py "Stocks" "goated prompts - Stocks.csv" "$SHEET_ID"
        python fetch_sheets.py "Studying" "goated prompts - Studying.csv" "$SHEET_ID"

    - name: Run HTML conversion script
      run: |
        python csv_to_html.py "goated prompts - General.csv" "docs/General.html" "General"
        python csv_to_html.py "goated prompts - Stocks.csv" "docs/Stocks.html" "Stocks"
        python csv_to_html.py "goated prompts - Studying.csv" "docs/Studying.html" "Studying"

    - name: Commit and push if changed
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add .
        if ! git diff --staged --quiet; then
          git commit -m "Automated build: Update CSV from Google Sheets and rebuild HTML"
          git push
        else
          echo "No changes to commit"
        fi